!function(){const jsmediatags=window.jsmediatags,imgPath="./img/",contentInner="./img/contentInner.png",cplayConfig="../resource/cplay.json",classEs={detail:{artist:getEle("cplay-artist"),title:getEle("cplay-title"),album:getEle("cplay-album"),picture:getEle("cplay-cover-img")},lyLi:getEles("cplay-lyrics"),lytime:getEles("cplay-lytime"),lyrics:getEle("cplay-lyrics-list"),editime:getEle("cplay-editime"),play:getEle("cplay-play"),volumebtn:getEle("cplay-volume-btn"),volume:getEle("cplay-volume"),uploading:getEle("cplay-uploading"),edit:getEle("cplay-edit"),save:getEle("cplay-save"),overview:getEle("cplay-overview"),copy:getEle("cplay-copy"),current:getEle("cplay-current"),ctt:getEle("cplay-ctt"),duration:getEle("cplay-duration"),uploadingFile:getEle("cplay-upload-file"),uploadbtn:getEle("cplay-upload"),bgi:getEle("cplay-bgi"),hintbox:getEle("cplay-hintbox"),setting:getEle("cplay-setting"),settingbox:getEle("cplay-settingbox")};function pageViewInit(cplay,data){imagSwitch(data.detail.picture,src=>{classEs.detail.picture.src=src,classEs.bgi.style.setProperty("background-image",`url(${src})`)}),classEs.detail.title.innerHTML=data.detail.title,classEs.detail.artist.innerHTML=data.detail.artist,classEs.detail.picture.style.setProperty("animation-play-state","paused"),data.isPlayed=!1,data.isEdited=!1,data.isDrag=!1,data.index=0,classEs.lyrics=classEs.lyrics||getEle("cplay-lyrics-list"),classEs.lyrics.innerHTML="";for(let lyLi of data.lyrics)classEs.lyrics.innerHTML+=`<li index='${data.index++}' class="lr-li cplay-lyrics"><span class='cplay-lytime' contenteditable>${lyLi.time}</span>${lyLi.data}</li>`;data.index=0,classEs.play.style.setProperty("background-image","url(./img/pause.svg)"),classEs.volumebtn.style.setProperty("width",100*data.options.volume+"%"),classEs.current.innerHTML="00:00",classEs.duration.innerHTML=secondsToFormat(data.duration,!1,0),classEs.ctt.style.setProperty("width","0%"),lyricsEdit(cplay)}function pagePlayerCtrl(p,cplay){addEve(p,"click",()=>{playerCtrl(cplay)})}function playerCtrl(cplay){cplay.playPause()}function pageVolumeCtrl(vbtn,cplay){addEve(classEs.volume,"click",(function(){getEle("m-vol").style.setProperty("display","block")})),addEve(getEle("m-vol"),"mouseleave",(function(){getEle("m-vol").style.setProperty("display","none")})),addEve(getEle("vbg"),"click",(function(event){let leftVal=vbtn.getBoundingClientRect().left,barWidth=getEle("vbg").getBoundingClientRect().width,barleft=event.clientX-leftVal;cplay.setVolume(barleft/barWidth)})),getEle("cplay-volume-btn .btn").onmousedown=function(){let leftVal=vbtn.getBoundingClientRect().left,barWidth=getEle("vbg").getBoundingClientRect().width;document.onmouseup=null,document.onmousemove=function(event){let barleft=event.clientX-leftVal;cplay.setVolume(barleft/barWidth),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()},document.onmouseup=function(){document.onmousemove=null}}}function pageProgressBar(cplay){cplay.getProcess(percent=>{cplay.data.isDrag||(classEs.current.innerHTML=secondsToFormat(cplay.getCurrentTime(),!1,0),classEs.ctt.style.setProperty("width",100*percent+"%")),cplay.data.isEdited||pageLyricsScroll(1*cplay.getCurrentTime(),cplay)}),addEve(getEle("barbg"),"click",(function(event){let leftVal=classEs.ctt.getBoundingClientRect().left,barWidth=getEle("barbg").getBoundingClientRect().width,barleft=event.clientX-leftVal;cplay.skip(barleft/barWidth)})),getEle("cplay-ctt .btn").onmousedown=function(){let leftVal=classEs.ctt.getBoundingClientRect().left,barWidth=getEle("barbg").getBoundingClientRect().width;document.onmouseup=null,document.onmousemove=function(event){cplay.data.isDrag=!0;let barleft,offset=(event.clientX-leftVal)/barWidth;offset<=0?offset=0:offset>1&&(offset=1),classEs.ctt.style.setProperty("width",100*offset+"%"),classEs.current.innerHTML=secondsToFormat(offset*cplay.audio.duration,!1,0),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()},document.onmouseup=function(event){if(cplay.data.isDrag=!1,document.onmousemove){let barleft=event.clientX-leftVal;cplay.skip(barleft/barWidth)}document.onmousemove=null}}}function pageLyricsScroll(currentime,cplay){cplay.data.index>=cplay.data.lyrics.length||(-1==cplay.data.index||cplay.getLyricsTime(cplay.data.index)<=currentime)&&(lyricsScroll(cplay,cplay.data.index),cplay.data.index++)}function lyricsScroll(cplay,index,flag=!0,ha=100){for(const li of getEles("cplay-lyrics"))li.classList.remove("active");-1==index?cplay.data.index=index=0:getEles("cplay-lyrics")[index].classList.add("active");let top,clientheight,height=getEles("cplay-lyrics")[index].offsetTop-classEs.lyrics.clientHeight/2+ha;flag?animate({duration:cplay.data.options.sad,timing:function(timeFraction){return-timeFraction*timeFraction+2*timeFraction},draw:function(progress){classEs.lyrics.scroll(0,height-39*(1-progress))}}):classEs.lyrics.scroll(0,height)}function setLyricsIndex(cplay,currentime){let orgtime;if(currentime<cplay.getLyricsTime(0))cplay.data.index=-1;else for(let i=0;i<cplay.data.lyrics.length;i++){if(i==cplay.data.lyrics.length-1)return void(cplay.data.index=i);if(cplay.getLyricsTime(i)<=currentime&&currentime<=cplay.getLyricsTime(i+1))return void(cplay.data.index=i)}}function pageLyricsEdit(cplay){addEve(classEs.edit,"click",()=>{lyricsEdit(cplay)}),pageLyricsView(cplay)}function lyricsEdit(cplay){cplay.data.isEdited=!0,classEs.lyrics.onclick=null,cplay.data.isEdited&&(hintBox(hints.edit),pageEditShortcuts(cplay),classEs.lyrics.onclick=function(e){if(e.target.children[0]){var ele=e.target.children[0];let index=e.target.getAttribute("index");ele.style.setProperty("display","inline-block"),document.onkeydown=null,e.target.onmouseleave=function(){lyricsSave(cplay,this.children[0],index),pageEditShortcuts(cplay)}}})}function pageLyricsView(cplay){addEve(classEs.overview,"click",()=>{lyricsView(cplay)})}function lyricsView(cplay){if(cplay.data.isEdited=!1,!cplay.data.isEdited){hintBox(hints.view),classEs.lyrics.onclick=null;for(const lyLi of getEles("cplay-lyrics"))lyLi.onmouseleave=null;document.onkeydown=null,pageShortcuts(cplay),setLyricsIndex(cplay,cplay.getCurrentTime())}}function lyricsSave(cplay,ele,index){return/^\[[0-9]{2}:[0-9]{2}\.[0-9]{3}\]$/.test(ele.innerText)?(cplay.setLyricsTime(index,ele.innerText),ele.style.setProperty("display","none"),!0):(alert("时间轴格式不对，请修改后保存"),!1)}function pageShortcuts(cplay){document.onkeydown=function(event){var event;switch((event=event||window.event).key.toLowerCase()){case" ":playerCtrl(cplay)}}}function pageEditShortcuts(cplay){document.onkeydown=function(event){var event;switch((event=event||window.event).key.toLowerCase()){case"enter":if(cplay.data.index<cplay.data.lyrics.length){let time=cplay.getCurrentTime();getEles("cplay-lyrics")[cplay.data.index].children[0].innerHTML=secondsToFormat(time,!0),lyricsSave(cplay,getEles("cplay-lyrics")[cplay.data.index].children[0],cplay.data.index),lyricsScroll(cplay,cplay.data.index),cplay.data.index++}break;case"q":if(cplay.data.index>1){cplay.data.index=cplay.data.index-2;let bftime=formatToSeconds(cplay.data.lyrics[cplay.data.index].time),offset=bftime/cplay.data.duration;cplay.skip(offset),classEs.ctt.style.setProperty("width",100*offset+"%"),classEs.current.innerHTML=secondsToFormat(bftime,!1,0),cplay.data.index++}else if(1==cplay.data.index){let bftime=formatToSeconds("[00:00.000]");cplay.skip(0),classEs.ctt.style.setProperty("width","0%"),classEs.current.innerHTML=secondsToFormat(bftime,!1,0)}break;case"enter":break;case" ":playerCtrl(cplay)}}}function pageCopyLyrics(cplay){addEve(classEs.copy,"click",(function(){let contents="";for(const ly of cplay.data.lyrics)contents+=`${ly.time}${ly.data}\n`;copyTxt(contents)}))}function copyTxt(text){if("function"!=typeof document.execCommand)return void console.log("歌词复制失败");var dom=document.createElement("textarea");dom.value=text,dom.setAttribute("style","display: block;width: 1px;height: 1px;"),document.body.appendChild(dom),dom.select();var result=document.execCommand("copy");if(document.body.removeChild(dom),result)return void hintBox(hints.copy);if("function"!=typeof document.createRange)return void console.log("歌词复制失败");var range=document.createRange(),div=document.createElement("div");div.innerHTML=text,div.setAttribute("style","height: 1px;fontSize: 1px;overflow: hidden;"),document.body.appendChild(div),range.selectNode(div);const selection=window.getSelection();selection.rangeCount>0&&selection.removeAllRanges(),selection.addRange(range),document.execCommand("copy"),hintBox(hints.copy)}function hintBox(content){classEs.hintbox.innerHTML=content,animate({duration:1e3,timing:function(timeFraction){return timeFraction*timeFraction},draw:function(progress){classEs.hintbox.style.setProperty("transform",`translate(-50%, ${50-150*progress}%)`),classEs.hintbox.style.setProperty("opacity",1-progress)}})}Cplay=function(options){this.init(options)},Cplay.prototype.init=async function(options){var _this=this;this.data=await readJsonFile(cplayConfig),this.audio=new Audio(this.data.url),this.audio.volume=this.data.options.volume,pageViewInit(this,this.data),this.pageListen()},Cplay.prototype.changeFile=function(musicfile,lyricsfile){var _this=this,url=URL.createObjectURL(musicfile);this.audio?this.audio.src=url:this.audio=new Audio(url),addEve(this.audio,"durationchange",(async function(){const mdata=await getMusicInfo(musicfile),ldata=await formatLyrics(lyricsfile);_this.data.detail=mdata.content,_this.data.lyrics=ldata.content,_this.data.duration=this.duration,_this.data.isPlayed=!this.paused,this.volume=_this.data.options.volume,this.audioRate=_this.data.audioRate,pageViewInit(_this,_this.data)}))},Cplay.prototype.pageListen=function(){pagePlayerCtrl(classEs.play,this),pageVolumeCtrl(classEs.volumebtn,this),pageProgressBar(this),pageLyricsEdit(this),pageEditShortcuts(this),pageCopyLyrics(this),settingBox()},Cplay.prototype.playPause=function(){this.data.isPlayed?(this.audio.pause(),classEs.play.style.setProperty("background-image","url(./img/pause.svg)"),classEs.detail.picture.style.setProperty("animation-play-state","paused")):(this.audio.play(),classEs.play.style.setProperty("background-image","url(./img/play.svg)"),classEs.detail.picture.style.setProperty("animation-play-state","running")),this.data.isPlayed=!this.data.isPlayed},Cplay.prototype.getCurrentTime=function(){return numberToFixed(this.audio.currentTime)},Cplay.prototype.getProcess=function(callback){addEve(this.audio,"timeupdate",(function(){callback(this.currentTime/this.duration)}))},Cplay.prototype.setVolume=function(v){v<=0?v=0:v>1&&(v=1),this.audio.volume=this.data.options.volume=1*numberToFixed(1*v,2),classEs.volumebtn.style.setProperty("width",100*v+"%")},Cplay.prototype.skip=function(offset){var _this=this;offset<=0?offset=0:offset>1&&(offset=1),this.audio.currentTime=offset*this.audio.duration,classEs.ctt.style.setProperty("width",this.getCurrentTime()/this.audio.duration*100+"%"),setLyricsIndex(this,this.getCurrentTime()),lyricsScroll(this,this.data.index,!1)},Cplay.prototype.isEnd=function(){var _this=this;addEve(this.audio,"ended",(function(){this.index=0,classEs.play.style.setProperty("background-image","url(./img/pause.svg)"),classEs.detail.picture.style.setProperty("animation-play-state","paused")}))},Cplay.prototype.getLyrics=function(index){return this.data.lyrics[index]},Cplay.prototype.getLyricsTime=function(index){return formatToSeconds(this.data.lyrics[index].time)},Cplay.prototype.setLyricsTime=function(index,time){this.data.lyrics[index].time=time},Cplay.prototype.setLyricsContent=function(index,lyrics){this.data.lyrics[index].data=lyrics};var hints={edit:"编辑模式",view:"预览模式",copy:"复制成功"};function settingBox(){addEve(classEs.setting,"click",(function(){animate({duration:300,timing:function(timeFraction){return timeFraction*timeFraction},draw:function(progress){classEs.settingbox.style.setProperty("transform",`translate(${150*progress-150}%, 0%)`)}})})),addEve(classEs.settingbox,"mouseleave",(function(){animate({duration:200,timing:function(timeFraction){return timeFraction*timeFraction},draw:function(progress){classEs.settingbox.style.setProperty("transform",`translate(${-150*progress}%, 0%)`)}})}))}function bounce(timeFraction){for(let a=0,b=1,result;;a+=b,b/=2)if(timeFraction>=(7-4*a)/11)return-Math.pow((11-6*a-11*timeFraction)/4,2)+Math.pow(b,2)}function makeEaseOut(timing){return function(timeFraction){return 1-timing(1-timeFraction)}}function animate({timing:timing,draw:draw,duration:duration}){let start=performance.now();requestAnimationFrame((function animate(time){let timeFraction=(time-start)/duration;timeFraction>1&&(timeFraction=1);let progress=timing(timeFraction);draw(progress),timeFraction<1&&requestAnimationFrame(animate)}))}async function readJsonFile(file){return new Promise(resolve=>{var rawFile=new XMLHttpRequest;rawFile.overrideMimeType("application/json"),rawFile.open("GET",file,!0),rawFile.onreadystatechange=function(){4===rawFile.readyState&&"200"==rawFile.status&&resolve(JSON.parse(rawFile.responseText))},rawFile.send(null)})}function addEve(media,eventName,callback,flag=!1){media.addEventListener(eventName,callback,flag)}function removeEve(media,eventName,functionName){media.removeEventListener(eventName,functionName)}function getEle(classE){return document.querySelector(`.${classE}`)}function getEles(classE){return document.querySelectorAll(`.${classE}`)}function imagSwitch(src,callback){let img=new Image;img.src=src,img.onload=function(){callback(this.src)}}function formatToSeconds(time,flag=!0){var times="[00:00.000]";return 60*(times=flag?time.slice(1,time.length-1).split(":"):time.split(":"))[0]+1*times[1]}function secondsToFormat(time,flag=!0,number=3){var minute=Math.floor(time/60),second=numberToFixed(time%60,number);return second>59&&(minute+=1,second=numberToFixed(0,number)),minute=minute<10?"0"+minute:minute,second=second<10?"0"+second:second,flag?`[${minute}:${second}]`:`${minute}:${second}`}function numberToFixed(data,number=3){return data.toFixed(number)}async function getMusicInfo(musicfile){return new Promise((resolve,reject)=>{jsmediatags.read(musicfile,{onSuccess:function(tag){var picture;if(tag.tags.picture){for(var imageData=tag.tags.picture.data,base64String="",i=0;i<imageData.length;i++)base64String+=String.fromCharCode(imageData[i]);picture="data:"+tag.tags.picture.format+";base64,"+window.btoa(base64String)}resolve({flag:!0,content:{artist:tag.tags.artist||"未知",title:tag.tags.title||"未知",album:tag.tags.album||"未知",picture:picture||contentInner}})},onError:reject})})}async function formatLyrics(file){return new Promise((resolve,reject)=>{let lyrics=[],reader=new FileReader;null==file&&resolve({flag:!1,content:"error"}),reader.readAsText(file,"utf8"),reader.onload=()=>{let data,arrdata;reader.result.replace(/(\r\n|\r)/g,"\n").split("\n").reduce((pre,cur)=>(""==pre&&pre==cur||lyrics.push({time:"[00:00.000]",data:cur}),cur),void 0),resolve({flag:!0,content:lyrics})}})}}();